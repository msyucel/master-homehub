<div class="homes-container">
  <div class="header-section">
    <h1>üè† My Homes</h1>
    <button class="add-button" (click)="toggleForm()">
      {{ showForm() ? 'Cancel' : '+ Add Home' }}
    </button>
  </div>

  @if (errorMessage(); as error) {
    <div class="error-message">{{ error }}</div>
  }

  @if (showForm()) {
    <div class="form-card">
      <h2>Add New Home</h2>
      <form [formGroup]="homeForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label for="name">Home Name *</label>
          <input
            type="text"
            id="name"
            formControlName="name"
            placeholder="e.g., Main House, Vacation Home"
            class="form-input"
          />
          @if (homeForm.get('name')?.invalid && homeForm.get('name')?.touched) {
            <span class="error-text">Home name is required</span>
          }
        </div>

        <div class="form-group">
          <label for="address">Address *</label>
          <textarea
            id="address"
            formControlName="address"
            placeholder="Enter home address"
            class="form-textarea"
            rows="3"
          ></textarea>
          @if (homeForm.get('address')?.invalid && homeForm.get('address')?.touched) {
            <span class="error-text">Address is required</span>
          }
        </div>

        <div class="form-actions">
          <button type="submit" class="submit-button" [disabled]="isLoading() || homeForm.invalid">
            {{ isLoading() ? 'Adding...' : 'Add Home' }}
          </button>
        </div>
      </form>
    </div>
  }

  @if (isLoading() && homes().length === 0) {
    <div class="loading">Loading homes...</div>
  }

  @if (!isLoading() && homes().length === 0 && !showForm()) {
    <div class="empty-state">
      <p>No homes added yet. Click "Add Home" to get started!</p>
    </div>
  }

  <div class="homes-grid">
    @for (home of homes(); track home.id) {
      <div class="home-card" (click)="navigateToHomeDetail(home.id)">
        <div class="home-header">
          <h3>{{ home.name }}</h3>
          <div class="home-actions" (click)="$event.stopPropagation()">
            @if (isOwner(home)) {
              <button class="add-member-button" (click)="openMemberModal(home.id)" title="Add member">
                üë•
              </button>
            }
            @if (isOwner(home)) {
              <button class="delete-button" (click)="deleteHome(home.id)" title="Delete home">
                üóëÔ∏è
              </button>
            }
          </div>
        </div>
        <p class="address">{{ home.address }}</p>
        <div class="home-members-section">
          <div class="members-header">
            <span class="members-label">Members:</span>
            @if (isOwner(home)) {
              <span class="owner-badge">Owner</span>
            } @else {
              <span class="member-badge">Member</span>
            }
          </div>
          @if (getHomeMembersList(home.id).length > 0) {
            <div class="members-list">
              @for (member of getHomeMembersList(home.id); track member.user_id || member.id) {
                <span class="member-chip" [class.owner-chip]="member.role === 'owner'">
                  {{ member.first_name }} {{ member.last_name }}
                  @if (member.role === 'owner') {
                    <span class="role-indicator">(Owner)</span>
                  }
                </span>
              }
            </div>
          } @else {
            <span class="no-members">No members yet</span>
          }
        </div>
        <p class="date">Added: {{ home.created_at | date:'medium' }}</p>
      </div>
    }
  </div>

  <!-- Member Modal -->
  @if (showMemberModal()) {
    <div class="modal-overlay" (click)="closeMemberModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Manage Home Members</h2>
          <button class="close-button" (click)="closeMemberModal()">√ó</button>
        </div>

        <div class="modal-body">
          @if (errorMessage(); as error) {
            <div class="error-message">{{ error }}</div>
          }

          @if (successMessage(); as success) {
            <div class="success-message">{{ success }}</div>
          }
          @if (selectedHomeId(); as homeId) {
            @if (getHomeMembersList(homeId).length > 0) {
              <div class="current-members-section">
                <h3>Current Members</h3>
                <div class="members-list">
                  @for (member of getHomeMembersList(homeId); track member.id) {
                    <div class="member-item">
                      <div class="member-avatar">
                        {{ member.first_name?.charAt(0)?.toUpperCase() }}{{ member.last_name?.charAt(0)?.toUpperCase() }}
                      </div>
                      <div class="member-info">
                        <span class="member-name">{{ member.first_name }} {{ member.last_name }}</span>
                        <span class="member-email">{{ member.email }}</span>
                      </div>
                    </div>
                  }
                </div>
              </div>
            }

            @if (getAvailableFamilies(homeId).length === 0) {
              <div class="empty-state">
                <p>No available family members to add. All family members are already members of this home.</p>
              </div>
            } @else {
              <form [formGroup]="memberForm" (ngSubmit)="onAddMember()">
                <div class="form-group">
                  <label for="userId">Add Family Member *</label>
                  <select id="userId" formControlName="userId" class="form-input">
                    <option value="">Choose a family member...</option>
                    @for (family of getAvailableFamilies(homeId); track family.id) {
                      <option [value]="getFamilyMemberId(family)">
                        {{ getFamilyMemberName(family) }}
                      </option>
                    }
                  </select>
                  @if (memberForm.get('userId')?.invalid && memberForm.get('userId')?.touched) {
                    <span class="error-text">Please select a family member</span>
                  }
                </div>

                <div class="form-actions">
                  <button type="button" class="cancel-button" (click)="closeMemberModal()">Cancel</button>
                  <button type="submit" class="submit-button" [disabled]="isLoading() || memberForm.invalid">
                    {{ isLoading() ? 'Sending...' : 'Send Invitation' }}
                  </button>
                </div>
              </form>
            }
          }
        </div>
      </div>
    </div>
  }
</div>

